# 🏇 Ballypatrick Auctions Deployment Guide

## Overview

This guide provides complete instructions for deploying the Ballypatrick Auctions platform on Ubuntu 22.04 servers (AWS EC2, DigitalOcean, or any Ubuntu-based server).

**Tech Stack:**
- Frontend: React 18 + Tailwind CSS + shadcn/ui + i18next
- Backend: FastAPI (Python 3.11) + Motor (async MongoDB)
- Database: MongoDB 7.x
- Features: JWT Auth, AI Translation, File Uploads, CMS

---

## 🚀 Quick Start (3 Steps)

### Step 1: Get Ubuntu Server

1. Launch an Ubuntu 22.04 LTS server (AWS EC2, DigitalOcean, etc.)
2. Minimum requirements:
   - **CPU:** 2 cores
   - **RAM:** 4 GB
   - **Storage:** 20 GB
   - **Ports:** 22 (SSH), 80 (HTTP), 3000 (Frontend), 8001 (Backend)

### Step 2: Upload Deployment Script

From your local machine:

```bash
scp -i YOUR-KEY.pem auto_deploy_auction.sh ubuntu@YOUR-SERVER-IP:~/
```

### Step 3: Run Deployment

SSH into your server:

```bash
ssh -i YOUR-KEY.pem ubuntu@YOUR-SERVER-IP
```

Run the installer:

```bash
sudo bash auto_deploy_auction.sh
```

Answer the questions:
1. GitHub repository URL
2. Branch name (default: main)
3. Database name (default: ballypatrick_auctions)
4. Admin email, username, password
5. OpenAI API key (optional)
6. Anthropic API key (optional)
7. Load demo data? (Y/N)

**Wait 10-15 minutes** - The installer does everything automatically!

---

## 📋 What Gets Installed

### System Dependencies
- ✅ Python 3.11
- ✅ Node.js 20.x
- ✅ Yarn package manager
- ✅ MongoDB 7.x
- ✅ Supervisor (process manager)

### Application Components
- ✅ React frontend with all dependencies
- ✅ FastAPI backend with all Python packages
- ✅ MongoDB collections and indexes
- ✅ Admin user account
- ✅ Demo data (optional)

### Services Configured
- ✅ Backend API (port 8001)
- ✅ Frontend app (port 3000)
- ✅ MongoDB (port 27017)
- ✅ Auto-restart on crashes
- ✅ Logging to /var/log/supervisor/

---

## 🗂️ Application Structure

After installation, your application will be at `/app/`:

```
/app/
├── backend/
│   ├── server.py                    # Main FastAPI app
│   ├── auth.py                     # JWT authentication
│   ├── models.py                   # Pydantic models
│   ├── routes/                     # API route modules
│   │   ├── auth_routes.py
│   │   ├── collections_routes.py
│   │   ├── lots_routes.py
│   │   ├── pages_routes.py
│   │   ├── menu_routes.py
│   │   ├── blog_routes.py
│   │   ├── translations_routes.py
│   │   ├── upload_routes.py
│   │   └── settings_routes.py
│   ├── uploads/                    # User uploaded files
│   ├── seed*.py                    # Database seeding scripts
│   ├── requirements.txt
│   └── .env                        # Backend configuration
│
├── frontend/
│   ├── src/
│   │   ├── components/
│   │   │   ├── admin/             # Admin components
│   │   │   ├── pageBuilder/       # CMS page builder
│   │   │   ├── ui/                # shadcn/ui components
│   │   │   ├── Navigation.jsx
│   │   │   ├── LanguageSwitcher.jsx
│   │   │   └── TranslatedText.jsx
│   │   ├── context/
│   │   │   ├── AuthContext.js
│   │   │   └── TranslationContext.js
│   │   ├── pages/                 # Page components
│   │   ├── services/
│   │   │   └── aiTranslationService.js
│   │   ├── App.js
│   │   ├── index.js
│   │   └── i18n.js               # i18next configuration
│   ├── package.json
│   ├── tailwind.config.js
│   └── .env                       # Frontend configuration
```

---

## 🔧 Configuration Files

### Backend Environment (`/app/backend/.env`)

```bash
MONGO_URL=mongodb://localhost:27017
DB_NAME=ballypatrick_auctions
JWT_SECRET=<auto-generated>
JWT_ALGORITHM=HS256
CORS_ORIGINS=*
OPENAI_API_KEY=<your-key>         # Optional
ANTHROPIC_API_KEY=<your-key>      # Optional
```

⚠️ **CRITICAL:** Never commit `.env` files to git!

### Frontend Environment (`/app/frontend/.env`)

```bash
REACT_APP_BACKEND_URL=http://localhost:8001
```

⚠️ **WARNING:** This URL is configured for the deployment environment. Do not modify unless you know what you're doing!

---

## 🌐 API Endpoints

All backend API routes use the `/api` prefix:

### Authentication
- `POST /api/auth/register` - Register new user
- `POST /api/auth/login` - Login and get JWT token
- `GET /api/auth/me` - Get current user info

### Collections
- `GET /api/collections` - List all collections
- `POST /api/collections` - Create collection (admin)
- `PUT /api/collections/{id}` - Update collection (admin)
- `DELETE /api/collections/{id}` - Delete collection (admin)

### Lots
- `GET /api/lots` - List all lots
- `GET /api/lots?collection_id={id}` - Filter by collection
- `POST /api/lots` - Create lot (admin)
- `PUT /api/lots/{id}` - Update lot (admin)
- `DELETE /api/lots/{id}` - Delete lot (admin)

### Pages (CMS)
- `GET /api/pages` - List pages
- `GET /api/pages/slug/{slug}` - Get page by slug
- `POST /api/pages` - Create page (admin)
- `PUT /api/pages/{id}` - Update page (admin)
- `DELETE /api/pages/{id}` - Delete page (admin)

### Menu
- `GET /api/menu/items` - Get menu items
- `POST /api/menu/items` - Create menu item (admin)
- `PUT /api/menu/items/{id}` - Update menu item (admin)
- `DELETE /api/menu/items/{id}` - Delete menu item (admin)

### Blog/News
- `GET /api/blog/posts` - List blog posts
- `GET /api/blog/posts/slug/{slug}` - Get post by slug
- `POST /api/blog/posts` - Create post (admin)
- `PUT /api/blog/posts/{id}` - Update post (admin)
- `DELETE /api/blog/posts/{id}` - Delete post (admin)

### Translations
- `POST /api/translations/translate` - AI translate text
- `GET /api/translations/status` - Translation status
- `GET /api/translations/cache` - View translation cache

### File Uploads
- `POST /api/upload` - Upload file (admin, multipart/form-data)
- `GET /api/uploads/{filename}` - Serve uploaded file

### Settings
- `GET /api/settings` - Get settings (admin)
- `PUT /api/settings/{category}` - Update settings (admin)

**API Documentation:** After deployment, visit `http://YOUR-SERVER-IP:8001/docs` for interactive API docs.

---

## 🔐 Authentication

The platform uses JWT (JSON Web Tokens) for authentication.

### Login Flow

1. **Login Request:**
```bash
curl -X POST http://YOUR-SERVER-IP:8001/api/auth/login \
  -H "Content-Type: application/json" \
  -d '{
    "email": "admin@ballypatrick.com",
    "password": "YourPassword"
  }'
```

2. **Response:**
```json
{
  "access_token": "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "token_type": "bearer",
  "user": {
    "id": "...",
    "email": "admin@ballypatrick.com",
    "username": "admin",
    "role": "admin"
  }
}
```

3. **Using the Token:**
```bash
curl http://YOUR-SERVER-IP:8001/api/collections \
  -H "Authorization: Bearer YOUR-JWT-TOKEN"
```

### Frontend Auth

The frontend uses `AuthContext` for managing authentication:

```javascript
import { useAuth } from './context/AuthContext';

function MyComponent() {
  const { user, login, logout } = useAuth();
  
  // User is logged in if user object exists
  if (user) {
    return <div>Welcome {user.username}!</div>;
  }
  
  return <LoginForm onLogin={login} />;
}
```

---

## 🌍 Multi-Language Support

The platform supports 8 languages:
1. English (en) - Default
2. French (fr)
3. Spanish (es)
4. German (de)
5. Arabic (ar)
6. Chinese (zh)
7. Japanese (ja)
8. Korean (ko)

### How Translation Works

1. User selects language via `LanguageSwitcher` component
2. Text wrapped in `<TranslatedText>` component is translated
3. Translations are cached in MongoDB
4. AI translation (OpenAI/Anthropic) used for new text

### Using Translations

```jsx
import TranslatedText from './components/TranslatedText';

function MyComponent() {
  return (
    <div>
      <TranslatedText text="Welcome to Ballypatrick Auctions" />
      <TranslatedText text="Browse our exclusive horse collections" />
    </div>
  );
}
```

### Adding AI Translation Keys

If you didn't add API keys during installation, you can add them later:

1. Edit `/app/backend/.env`:
```bash
OPENAI_API_KEY=sk-...your-key...
ANTHROPIC_API_KEY=sk-ant-...your-key...
```

2. Restart backend:
```bash
sudo supervisorctl restart auction-backend
```

---

## 📦 Updating the Application

### Method 1: Git Pull (Recommended)

```bash
# SSH into your server
ssh ubuntu@YOUR-SERVER-IP

# Navigate to app directory
cd /app

# Pull latest changes
git pull

# Update backend dependencies if changed
cd backend
pip3 install -r requirements.txt

# Update frontend dependencies if changed
cd ../frontend
yarn install

# Restart services
sudo supervisorctl restart all
```

### Method 2: Re-run Deployment Script

```bash
# This will backup existing installation and deploy fresh
sudo bash auto_deploy_auction.sh
```

---

## 🛠️ Service Management

### Check Service Status

```bash
sudo supervisorctl status
```

Expected output:
```
auction-backend      RUNNING   pid 1234, uptime 1:23:45
auction-frontend     RUNNING   pid 1235, uptime 1:23:45
```

### Restart Services

```bash
# Restart backend only
sudo supervisorctl restart auction-backend

# Restart frontend only
sudo supervisorctl restart auction-frontend

# Restart all services
sudo supervisorctl restart all
```

### Stop Services

```bash
sudo supervisorctl stop auction-backend
sudo supervisorctl stop auction-frontend
```

### Start Services

```bash
sudo supervisorctl start auction-backend
sudo supervisorctl start auction-frontend
```

---

## 📊 Viewing Logs

### Backend Logs

```bash
# View last 50 lines
tail -n 50 /var/log/supervisor/auction-backend.err.log

# Follow logs in real-time
tail -f /var/log/supervisor/auction-backend.err.log

# Search for errors
grep -i error /var/log/supervisor/auction-backend.err.log
```

### Frontend Logs

```bash
# View last 50 lines
tail -n 50 /var/log/supervisor/auction-frontend.err.log

# Follow logs in real-time
tail -f /var/log/supervisor/auction-frontend.err.log
```

### MongoDB Logs

```bash
sudo journalctl -u mongod -n 50
sudo journalctl -u mongod -f
```

---

## 🗄️ Database Management

### Access MongoDB Shell

```bash
mongosh
```

Then:
```javascript
// Switch to your database
use ballypatrick_auctions

// View collections
show collections

// Query users
db.users.find().pretty()

// Query collections
db.collections.find().pretty()

// Query lots
db.lots.find().pretty()

// Exit
exit
```

### Backup Database

```bash
# Backup to file
mongodump --db ballypatrick_auctions --out /backup/$(date +%Y%m%d)

# Compress backup
tar -czf /backup/db_backup_$(date +%Y%m%d).tar.gz /backup/$(date +%Y%m%d)
```

### Restore Database

```bash
# Extract backup
tar -xzf /backup/db_backup_20250115.tar.gz -C /tmp

# Restore
mongorestore --db ballypatrick_auctions /tmp/20250115/ballypatrick_auctions
```

### Re-seed Database

```bash
cd /app/backend

# Seed admin user
python3 seed.py

# Seed menu
python3 seed_menu.py

# Seed pages
python3 seed_pages.py

# Seed demo collections and lots
python3 seed_collections_lots.py
```

---

## 🚨 Troubleshooting

### Frontend Won't Start

**Symptoms:** 
- Port 3000 not accessible
- "Frontend is not responding" message

**Solutions:**

1. Check if Yarn is installed:
```bash
yarn --version
```

2. Check if dependencies are installed:
```bash
cd /app/frontend
ls node_modules/
```

3. Manually install dependencies:
```bash
cd /app/frontend
rm -rf node_modules yarn.lock
yarn install
sudo supervisorctl restart auction-frontend
```

4. Check logs for errors:
```bash
tail -f /var/log/supervisor/auction-frontend.err.log
```

### Backend Won't Start

**Symptoms:**
- Port 8001 not accessible
- API returns 502/503

**Solutions:**

1. Check Python version:
```bash
python3 --version  # Should be 3.11+
```

2. Check if dependencies are installed:
```bash
cd /app/backend
pip3 list | grep fastapi
```

3. Manually install dependencies:
```bash
cd /app/backend
pip3 install -r requirements.txt
sudo supervisorctl restart auction-backend
```

4. Check for import errors:
```bash
cd /app/backend
python3 -c "import server"
```

5. Check logs:
```bash
tail -f /var/log/supervisor/auction-backend.err.log
```

### MongoDB Connection Failed

**Symptoms:**
- "Connection refused" errors
- Backend fails to start

**Solutions:**

1. Check if MongoDB is running:
```bash
sudo systemctl status mongod
```

2. Start MongoDB:
```bash
sudo systemctl start mongod
sudo systemctl enable mongod
```

3. Check connection:
```bash
mongosh
```

4. Verify MONGO_URL in .env:
```bash
cat /app/backend/.env | grep MONGO_URL
```

### API Returns 404

**Symptoms:**
- API endpoints return 404 Not Found

**Causes & Solutions:**

1. **Missing `/api` prefix:**
   - ❌ Wrong: `http://server:8001/collections`
   - ✅ Correct: `http://server:8001/api/collections`

2. **Route not registered:**
   - Check that route file is imported in `server.py`
   - Verify route prefix matches

3. **Backend not running:**
```bash
sudo supervisorctl status auction-backend
```

### Translation Not Working

**Symptoms:**
- Text not translating
- Translation errors in logs

**Solutions:**

1. Check API keys in .env:
```bash
cat /app/backend/.env | grep API_KEY
```

2. Verify AI service is accessible:
```bash
curl https://api.openai.com/v1/models \
  -H "Authorization: Bearer YOUR-API-KEY"
```

3. Check translation cache:
```javascript
mongosh
use ballypatrick_auctions
db.translation_cache.find().pretty()
```

### File Upload Fails

**Symptoms:**
- Upload returns error
- Files not appearing

**Solutions:**

1. Check uploads directory exists:
```bash
ls -la /app/backend/uploads/
```

2. Check permissions:
```bash
sudo chmod 755 /app/backend/uploads
```

3. Check disk space:
```bash
df -h
```

4. Check file size limits in backend:
```python
# In server.py, check:
app.add_middleware(
    MaxSizeMiddleware,
    max_upload_size=10 * 1024 * 1024  # 10 MB
)
```

---

## 🔒 Security Best Practices

### 1. Change Admin Password

After first login, change the default admin password:

```bash
# Using API
curl -X PUT http://YOUR-SERVER-IP:8001/api/auth/change-password \
  -H "Authorization: Bearer YOUR-JWT-TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "old_password": "ChangeMe123!",
    "new_password": "YourNewSecurePassword123!"
  }'
```

### 2. Secure Environment Variables

```bash
# Restrict access to .env files
chmod 600 /app/backend/.env
chmod 600 /app/frontend/.env
```

### 3. Enable Firewall

```bash
# Install UFW
sudo apt-get install ufw

# Allow SSH
sudo ufw allow 22

# Allow HTTP
sudo ufw allow 80

# Allow HTTPS (if using SSL)
sudo ufw allow 443

# Enable firewall
sudo ufw enable
```

### 4. Set Up SSL/HTTPS

For production deployments, use SSL:

```bash
# Install certbot
sudo apt-get install certbot python3-certbot-nginx

# Get SSL certificate
sudo certbot --nginx -d yourdomain.com

# Auto-renewal
sudo systemctl enable certbot.timer
```

### 5. Rotate JWT Secret

Periodically rotate your JWT secret:

```bash
# Generate new secret
openssl rand -hex 32

# Update .env
nano /app/backend/.env
# Change JWT_SECRET to new value

# Restart backend
sudo supervisorctl restart auction-backend
```

---

## 📈 Performance Optimization

### Frontend Optimization

1. **Build for Production:**
```bash
cd /app/frontend
yarn build
# Serve build folder instead of development server
```

2. **Enable Caching:**
   - Use React.memo for expensive components
   - Implement useMemo for computed values
   - Use useCallback for event handlers

3. **Code Splitting:**
   - Use React.lazy() for route-based splitting
   - Load heavy components on-demand

### Backend Optimization

1. **Database Indexing:**
```javascript
mongosh
use ballypatrick_auctions

// Index on commonly queried fields
db.collections.createIndex({ year: 1 })
db.lots.createIndex({ collection_id: 1 })
db.pages.createIndex({ slug: 1 })
db.users.createIndex({ email: 1 })
```

2. **Enable Response Caching:**
```python
# In routes, use caching decorator
from fastapi_cache.decorator import cache

@router.get("/collections")
@cache(expire=60)  # Cache for 60 seconds
async def get_collections():
    ...
```

3. **Use Connection Pooling:**
```python
# MongoDB connection pooling (already configured in Motor)
client = AsyncIOMotorClient(
    mongo_url,
    maxPoolSize=50
)
```

---

## 📞 Support & Resources

### Documentation
- **FastAPI:** https://fastapi.tiangolo.com/
- **React:** https://react.dev/
- **MongoDB:** https://docs.mongodb.com/
- **i18next:** https://www.i18next.com/
- **Tailwind CSS:** https://tailwindcss.com/

### Logs Location
- Backend: `/var/log/supervisor/auction-backend.err.log`
- Frontend: `/var/log/supervisor/auction-frontend.err.log`
- MongoDB: `sudo journalctl -u mongod`
- Deployment: `/var/log/auto_deploy_auction_*.log`

### Useful Commands Summary

```bash
# Service management
sudo supervisorctl status
sudo supervisorctl restart all

# View logs
tail -f /var/log/supervisor/auction-backend.err.log
tail -f /var/log/supervisor/auction-frontend.err.log

# Update application
cd /app && git pull && sudo supervisorctl restart all

# Database backup
mongodump --db ballypatrick_auctions --out /backup/$(date +%Y%m%d)

# Check ports
netstat -tulpn | grep -E ':(3000|8001|27017)'

# Disk usage
df -h
du -sh /app/*
```

---

## ✅ Post-Deployment Checklist

- [ ] Application accessible via browser
- [ ] Can login with admin credentials
- [ ] API documentation accessible at /docs
- [ ] All services running in supervisor
- [ ] Database connected and seeded
- [ ] Translation working (if API keys provided)
- [ ] File uploads working
- [ ] Admin can create/edit collections
- [ ] Admin can create/edit lots
- [ ] Admin can manage pages
- [ ] Changed default admin password
- [ ] Enabled firewall (if production)
- [ ] Set up backups
- [ ] Configured SSL (if domain available)

---

## 🎉 Success!

Your Ballypatrick Auctions platform is now fully deployed and operational!

For questions or issues, check the troubleshooting section above or review the logs.

**Happy Auctioneering! 🏇**
